<html lang="en">
<!-- Copyright 2024 © Marc Sonne Dahl -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KNX TP Telegram Visualizer</title>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(45deg, #1a2634, #0f1620);
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(26, 38, 52, 0.3);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      color: #4fd1c5;
      text-align: center;
      margin-bottom: 30px;
      text-shadow: 0 0 10px rgba(79, 209, 197, 0.5);
    }

    .block {
      margin: 20px 0;
      background: rgba(35, 52, 70, 0.4);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }

    .block:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 255, 255, 0.2);
    }

    .telegram {
      font-family: 'Courier New', monospace;
      margin-top: 20px;
      background: rgba(44, 66, 87, 0.4);
      padding: 20px;
      border-radius: 10px;
      overflow-x: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .binary-block {
      display: inline-block;
      padding: 10px;
      margin: 5px;
      border: 1px solid rgba(79, 209, 197, 0.5);
      background: rgba(35, 52, 70, 0.6);
      border-radius: 5px;
      transition: all 0.3s ease;
      word-wrap: break-word;
      word-break: break-all;
      max-width: 100%;
      box-shadow: 0 0 10px rgba(79, 209, 197, 0.2);
    }

    .binary-block:hover {
      background: rgba(44, 66, 87, 0.8);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(79, 209, 197, 0.3);
    }

    label {
      display: inline-block;
      width: 200px;
      color: #4fd1c5;
      text-shadow: 0 0 5px rgba(79, 209, 197, 0.5);
    }

    .section-title {
      margin-top: 30px;
      font-weight: bold;
      color: #4fd1c5;
      text-shadow: 0 0 10px rgba(79, 209, 197, 0.5);
    }

    input[type="number"],
    select {
      background: rgba(44, 66, 87, 0.4);
      border: 1px solid rgba(79, 209, 197, 0.5);
      color: #e0e0e0;
      padding: 5px 10px;
      border-radius: 5px;
      margin: 5px 0;
      transition: all 0.3s ease;
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 10px rgba(79, 209, 197, 0.5);
    }

    button {
      background: linear-gradient(45deg, #4fd1c5, #3db1a8);
      color: #0f1620;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(79, 209, 197, 0.3);
    }

    button:hover {
      background: linear-gradient(45deg, #3db1a8, #4fd1c5);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(79, 209, 197, 0.4);
    }

    #timingInfo {
      margin-top: 20px;
      background: rgba(35, 52, 70, 0.4);
      padding: 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>KNX TP<br>Telegram Visualizer</h1>

    <div class="block">
      <label>Source Address:</label><br>
      Area (0-15): <input type="number" id="sourceArea" min="0" max="15" value="0"><br>
      Line (0-15): <input type="number" id="sourceLine" min="0" max="15" value="0"><br>
      Device (0-255): <input type="number" id="sourceDevice" min="0" max="255" value="0">
    </div>

    <div class="block">
      <label>Destination Address:</label><br>
      Main Group (0-31): <input type="number" id="destMainGroup" min="0" max="31" value="0"><br>
      Middle Group (0-7): <input type="number" id="destMiddleGroup" min="0" max="7" value="0"><br>
      Group Address (0-255): <input type="number" id="destGroupAddress" min="0" max="255" value="0">
    </div>

    <div class="block">
      <label for="routingCounter">Routing Counter (0-7):</label>
      <input type="number" id="routingCounter" min="0" max="7" value="0">
    </div>

    <div class="block">
      <label for="priority">Priority:</label>
      <select id="priority">
        <option value="00">System (00)</option>
        <option value="01">High (01)</option>
        <option value="10">Alarm (10)</option>
        <option value="11">Low (11)</option>
      </select>
    </div>

    <div class="block">
      <label for="dptValue">DPT Size:</label><br>
      <input type="number" id="dptValue" value="1" min="1">
      <select id="dptType">
        <option value="1">Bit</option>
        <option value="8">Byte</option>
      </select>
    </div>

    <button onclick="generateTelegram()">Generate Telegram</button>

    <h2 class="section-title">Telegram Transmission Process</h2>
    <div><strong>T1 Pause:</strong> The time before a new telegram starts transmitting on the bus after it's idle.</div>
    <div class="telegram" id="telegramOutput"></div>
    <div><strong>T2 Pause:</strong> The time after the telegram is sent, during which devices verify reception.</div>
    <div><strong>Acknowledgment:</strong> Devices acknowledge receipt of the telegram.</div>
    <h2 class="section-title">Timing Information</h2>
    <div id="timingInfo"></div>
  </div>

  <script>
    function padBinary(binary, length) {
      return binary.padStart(length, '0');
    }

    function formatBinary(binary, groupSizes) {
      let result = '';
      let index = 0;
      for (let size of groupSizes) {
        if (result) result += ' ';
        result += binary.substr(index, size);
        index += size;
      }
      return result;
    }

    function generateTelegram() {
      const sourceArea = padBinary((+document.getElementById("sourceArea").value).toString(2), 4);
      const sourceLine = padBinary((+document.getElementById("sourceLine").value).toString(2), 4);
      const sourceDevice = padBinary((+document.getElementById("sourceDevice").value).toString(2), 8);
      const destinationMainGroup = padBinary((+document.getElementById("destMainGroup").value).toString(2), 5);
      const destinationMiddleGroup = padBinary((+document.getElementById("destMiddleGroup").value).toString(2), 3);
      const destinationGroupAddress = padBinary((+document.getElementById("destGroupAddress").value).toString(2), 8);
      const routingCounter = padBinary((+document.getElementById("routingCounter").value).toString(2), 3);
      const priority = document.getElementById("priority").value;
      const dptValue = +document.getElementById("dptValue").value;
      const dptType = document.getElementById("dptType").value;
      // Calculate DPT size in bits
      const dptSize = dptType === "1" ? dptValue : dptValue * 8;
      // Default fields
      const controlField = "10101010"; // Example 8 bits
      const npci = "00001010"; // Example 8 bits
      const apci = "001100"; // Example 6 bits
      const checksum = "11110000"; // Example 8 bits
      // Generate Data Field
      let dataField = "";
      if (dptSize === 1) {
        dataField = "1"; // Single bit data
      } else {
        dataField = "0".repeat(dptSize); // DPT size in bits
      }
      // Construct the binary telegram with formatted binary
      const sourceAddress = formatBinary(sourceArea + sourceLine + sourceDevice, [4, 4, 8]);
      const destinationAddress = formatBinary(destinationMainGroup + destinationMiddleGroup + destinationGroupAddress, [5, 3, 8]);
      const telegram = `
                <div class="binary-block"><strong>Control Field:</strong><br> ${controlField}</div>
                <div class="binary-block"><strong>Source Address:</strong><br> ${sourceAddress}</div>
                <div class="binary-block"><strong>Destination Address:</strong><br> ${destinationAddress}</div>
                <div class="binary-block"><strong>Routing Counter:</strong><br> ${routingCounter}</div>
                <div class="binary-block"><strong>Priority:</strong><br> ${priority}</div>
                <div class="binary-block"><strong>NPCI:</strong><br> ${npci}</div>
                <div class="binary-block"><strong>APCI + Data:</strong><br> ${apci}${dataField}</div>
                <div class="binary-block"><strong>Frame Checksum:</strong><br> ${checksum}</div>
            `;
      document.getElementById("telegramOutput").innerHTML = telegram;
      // Calculate total number of bits
      const totalBits = controlField.length + sourceAddress.replace(/\s/g, '').length + destinationAddress.replace(/\s/g, '').length +
        routingCounter.length + priority.length + npci.length +
        (apci.length + dataField.length) + checksum.length;
      // Calculate transmission time in microseconds
      const transmissionTime = totalBits * 104; // 1 bit = 104 µs at 9600 bps
      // Calculate the T2 pause based on the transmission time
      let t2Pause = 0;
      if (dptSize === 1) {
        t2Pause = 20000 - transmissionTime; // 1-bit DPT takes 20 ms
      } else if (dptSize === 128) {
        t2Pause = 40000 - transmissionTime; // 16-byte DPT takes 40 ms
      } else {
        t2Pause = (20000 + ((dptSize - 1) * 156.25)) - transmissionTime; // Extrapolate for other DPT sizes
      }
      // Convert times to milliseconds for display
      const transmissionTimeMs = (transmissionTime / 1000).toFixed(2);
      const t2PauseMs = (t2Pause / 1000).toFixed(2);
      document.getElementById("timingInfo").innerHTML = `
                <div><strong>Total Bits:</strong> ${totalBits} bits</div>
                <div><strong>Transmission Time:</strong> ${transmissionTimeMs} ms</div>
                <div><strong>Adjusted T2 Pause:</strong> ${t2PauseMs} ms</div>
            `;
    }
  </script>
</body>
<!-- Copyright 2024 © Marc Sonne Dahl -->

</html>